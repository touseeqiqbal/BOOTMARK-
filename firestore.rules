rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user owns the document
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Users collection
    match /users/{userId} {
      // Users can read their own data
      allow read: if isOwner(userId);
      // Only admins can write (handled by backend service account)
      allow write: if false; // Backend uses service account, not user auth
    }
    
    // Forms collection
    match /forms/{formId} {
      // Users can read forms they own
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      // Users can create forms
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      // Users can update their own forms
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;
      // Users can delete their own forms
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }
    
    // Submissions collection
    match /submissions/{submissionId} {
      // Users can read submissions for their forms
      allow read: if isAuthenticated() && resource.data.formId != null;
      // Anyone can create submissions (public forms)
      allow create: if true;
      // Users can update/delete submissions for their forms
      allow update, delete: if isAuthenticated() && resource.data.formId != null;
    }
    
    // Invoices collection
    match /invoices/{invoiceId} {
      // Users can read their own invoices
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      // Users can create invoices
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      // Users can update their own invoices
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;
      // Users can delete their own invoices
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }
    
    // Businesses collection
    match /businesses/{businessId} {
      // Users can read businesses they own
      allow read: if isAuthenticated() && resource.data.ownerId == request.auth.uid;
      // Users can create businesses
      allow create: if isAuthenticated() && request.resource.data.ownerId == request.auth.uid;
      // Users can update their own businesses
      allow update: if isAuthenticated() && resource.data.ownerId == request.auth.uid;
      // Only admins can delete (handled by backend)
      allow delete: if false;
    }
    
    // Customers collection
    match /customers/{customerId} {
      // Users can read customers they own
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      // Users can create customers
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      // Users can update their own customers
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;
      // Users can delete their own customers
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }
    
    // Members collection
    match /members/{memberId} {
      // Users can read members of their business
      allow read: if isAuthenticated();
      // Only admins can write (handled by backend)
      allow write: if false;
    }
    
    // Invites collection
    match /invites/{inviteId} {
      // Users can read invites for their forms
      allow read: if isAuthenticated();
      // Users can create invites
      allow create: if isAuthenticated();
      // Users can update/delete invites
      allow update, delete: if isAuthenticated();
    }
    
    // Form templates collection
    match /formTemplates/{templateId} {
      // Users can read their own templates or default templates
      allow read: if isAuthenticated();
      // Users can create templates
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      // Users can update their own templates
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;
      // Users can delete their own templates
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }
    
    // Default: Deny all other access
    match /{document=**} {
      allow read, write: if false;
    }
  }
}

